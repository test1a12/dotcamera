<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>レトロドット変換</title>
<style>
  body { margin:0; font-family: system-ui, -apple-system, sans-serif; background:#0f1115; color:#e6e6eb; min-height: 100vh; display: flex; flex-direction: column; }
  header { padding:8px; text-align:center; }
  h1 { font-size:16px; margin:6px 0; }
  .panel { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; padding:8px; background:#0f1115; position:sticky; top:0; z-index:10; }
  .panel > * { background:#171a21; border:1px solid #2a2f3a; color:#e6e6eb; border-radius:8px; padding:6px 10px; font-size:14px; }
  .stage { width:100vw; height:100vh; overflow:hidden; display:flex; align-items:center; justify-content:center; flex: 1; }
  canvas { width: 100vw; height: 100vh; object-fit: contain; image-rendering: pixelated; display:block; }
  video { display:none; }
  footer { text-align: center; font-size: 12px; color: #777; padding: 10px 0 14px; }
</style>
</head>
<body>

<header>
  <h1>レトロ ドット変換</h1>
</header>

<div class="panel">
  <input type="file" id="file" accept="image/*">
  <label>ドット数 <input id="dotSize" type="number" value="100" min="4" max="2048"></label>
  <label>色数 <input id="colorCount" type="number" value="8" min="1"></label>
  <select id="mode">
    <option value="preset">プリセット</option>
    <option value="random">ランダム</option>
    <option value="custom">手動</option>
  </select>
  <select id="preset">
    <option value="sunset2">Sunset 2</option>
    <option value="mono8">モノクロ</option>
    <option value="gb8">古いゲーム風</option>
    <option value="dusty5">くすみカラー</option>
    <option value="vivid5">ビビッド</option>
    <option value="pop5">ポップ</option>
  </select>
  <button id="convert">変換</button>
  <button id="realtime">リアルタイム開始</button>
  <button id="switchCam">フロント/リア切替</button>
  <button id="save">保存</button>
  <button id="saveAll">一括保存</button>
</div>

<div class="stage">
  <canvas id="canvas"></canvas>
  <video id="video" playsinline></video>
</div>

<footer>Copyright © 2026 SirogomaAZARASI All rights reserved.</footer>

<script>
const PRESETS = {
  sunset2: [[44,62,76],[66,75,82],[109,102,94],[163,132,104],[189,141,101],[211,158,108],[255,192,118],[204,206,185]],
  mono8: [[0,0,0],[64,64,64],[128,128,128],[192,192,192],[255,255,255]],
  gb8: [[15,56,15],[48,98,48],[139,172,15],[155,188,15],[220,240,140],[255,255,255]],
  dusty5: [[37,40,61],[111,146,131],[166,117,161],[206,162,172],[239,217,206]],
  vivid5: [[41,47,54],[78,205,196],[252,171,16],[255,107,107],[255,255,255]],
  pop5: [[29,47,111],[131,144,250],[250,199,72],[249,233,236],[36,130,50]]
};

const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d', { willReadFrequently: true });
ctx.imageSmoothingEnabled = false;
const video = document.getElementById('video');

let img = new Image();
let stream = null;
let useFront = false;
let realtimeOn = false;
let rafId = null;
let fixedRandomPalette = null;

function fitSize(sw,sh,d){
  const a=sw/sh;
  return sw>=sh ? [d, Math.max(1,Math.round(d/a))] : [Math.max(1,Math.round(d*a)), d];
}
function quantize(imgData, pal){
  const d=imgData.data;
  for(let i=0;i<d.length;i+=4){
    let r=d[i],g=d[i+1],b=d[i+2], best=pal[0], min=1e9;
    for(const p of pal){
      const dr=r-p[0],dg=g-p[1],db=b-p[2];
      const dist=dr*dr+dg*dg+db*db;
      if(dist<min){ min=dist; best=p; }
    }
    d[i]=best[0]; d[i+1]=best[1]; d[i+2]=best[2];
  }
}
function drawFromVideo(){
  if(!realtimeOn) return;
  const [w,h]=fitSize(video.videoWidth||640, video.videoHeight||480, dotSize.value|0);
  canvas.width=w; canvas.height=h;
  ctx.drawImage(video,0,0,w,h);
  const id=ctx.getImageData(0,0,w,h);
  quantize(id, PRESETS[preset.value]);
  ctx.putImageData(id,0,0);
  rafId=requestAnimationFrame(drawFromVideo);
}

realtime.onclick=async()=>{
  realtimeOn=!realtimeOn;
  realtime.textContent = realtimeOn?'リアルタイム停止':'リアルタイム開始';
  if(realtimeOn){
    stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode: useFront?'user':'environment' }, audio:false });
    video.srcObject = stream; await video.play();
    drawFromVideo();
  }else{
    cancelAnimationFrame(rafId);
    if(stream) stream.getTracks().forEach(t=>t.stop());
  }
};

switchCam.onclick=async()=>{ useFront=!useFront; if(realtimeOn) realtime.onclick(); };

saveAll.onclick = async () => {
  if (!realtimeOn) { alert('リアルタイム中に使ってください'); return; }
  const original = preset.value;
  for (const key of Object.keys(PRESETS)) {
    preset.value = key;
    await new Promise(r=>setTimeout(r,120));
    await new Promise(res=>{
      canvas.toBlob(b=>{
        const a=document.createElement('a');
        a.href=URL.createObjectURL(b);
        a.download=`camera_${key}.png`;
        a.click();
        res();
      });
    });
  }
  preset.value = original;
};
</script>
</body>
</html>